namespace: backing

bases:
- ../namespace

resources:
# git clone https://github.com/mongodb/mongodb-enterprise-kubernetes.git master (7.1)
- crds.yaml
#- pull-secret.yaml
- mongodb-enterprise.yaml
- ops-manager-admin-secret.yaml
- ops-manager.yaml

# readiness probe was killing pod before it could start in CRC
# test - these patches were under Deployment...patchesStrategicMerge:
#  - op: replace
#    path: /spec/template/spec/containers/0/env/3
#    value:
#      name: MONGODB_ENTERPRISE_DATABASE_IMAGE
#      value: registry.connect.redhat.com/mongodb/mongodb-enterprise-database
#  - op: replace
#    path: /spec/template/spec/containers/0/env/0
#    value:
#      name: OPERATOR_ENV
#      value: dev
#  - op: replace
#    path: /spec/template/spec/containers/0/env/5
#    value:
#      name: OPS_MANAGER_IMAGE_REPOSITORY
#      value: registry.connect.redhat.com/mongodb/mongodb-enterprise-ops-manager
#  - op: replace
#    path: /spec/template/spec/containers/0/env/6
#    value:
#      name: INIT_OPS_MANAGER_IMAGE_REPOSITORY
#      value: registry.connect.redhat.com/mongodb/mongodb-enterprise-init-ops-manager
#  - op: replace
#    path: /spec/template/spec/containers/0/env/8
#    value:
#      name: INIT_APPDB_IMAGE_REPOSITORY
#      value: registry.connect.redhat.com/mongodb/mongodb-enterprise-init-appdb
#  - op: replace
#    path: /spec/template/spec/containers/0/env/9
#    value:
#      name: INIT_APPDB_VERSION
#      value: latest
#  - op: replace
#    path: /spec/template/spec/containers/0/env/11
#    value:
#      name: APPDB_IMAGE_REPOSITORY
#      value: registry.connect.redhat.com/mongodb/mongodb-enterprise-appdb
#  - op: remove
#    path: /spec/applicationDatabase/version
#  - op: add
#    path: /spec/applicationDatabase/podSpec/memory
#    value: 500Mi
patchesJson6902:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: mongodb-enterprise-operator
    namespace: mongodb
  patch: |-
    - op: remove
      path: /spec/template/spec/securityContext
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: MANAGED_SECURITY_CONTEXT
        value: "true"
- target:
    group: rbac.authorization.k8s.io
    version: v1
    kind: ClusterRoleBinding
    name: mongodb-enterprise-operator-mongodb-webhook-binding
    namespace: mongodb
  patch: |-
    - op: remove
      path: /metadata/namespace
- target:
    group: rbac.authorization.k8s.io
    version: v1
    kind: ClusterRoleBinding
    name: mongodb-enterprise-operator-mongodb-certs-binding
    namespace: mongodb
  patch: |-
    - op: remove
      path: /metadata/namespace
- target:
    group: mongodb.com
    version: v1
    kind: MongoDBOpsManager
    name: ops-manager
  patch: |-
    - op: add
      path: /spec/configuration
      value:
        mms.ignoreInitialUiSetup: "true"
        automation.versions.source: mongodb
        mms.adminEmailAddr: foo@bar.com
        mms.fromEmailAddr: foo@bar.com
        mms.mail.hostname: foo@bar.com
        mms.mail.port: "465"
        mms.mail.ssl: "true"
        mms.mail.transport: smtp
        mms.minimumTLSVersion: TLSv1.2
        mms.replyToEmailAddr: foo@bar.com
    - op: remove
      path: /spec/clusterDomain
    - op: add
      path: /spec/backup
      value:
        enabled: false
    - op: replace
      path: /spec/replicas
      value: 1
    - op: add
      path: /spec/applicationDatabase/featureCompatibilityVersion
      value: "4.2"
    - op: add
      path: /spec/statefulSet
      value:
        spec:
          template:
            spec:
              containers:
                - name: mongodb-ops-manager
                  readinessProbe:
                    failureThreshold: 100
#                  resources:
#                    limits:
#                      memory: 2Gi
#                    requests:
#                      memory: 2Gi
#    - op: replace
#      path: /spec/applicationDatabase/persistent
#      value: false
#    - op: replace
#      path: /spec/applicationDatabase/version
#      value: 4.2.2-ent
#    - op: replace
#      path: /spec/version
#      value: 4.2.6
#    - op: replace
#      path: /spec/replicas
#      value: 1
#- target:
#    version: v1
#    kind: ServiceAccount
#    name: mongodb-enterprise-operator
#    namespace: mongodb
#  patch: |-
#    - op: add
#      path: /imagePullSecrets
#      value:
#        - name: openshift-pull-secret
#- target:
#    version: v1
#    kind: ServiceAccount
#    name: mongodb-enterprise-appdb
#    namespace: mongodb
#  patch: |-
#    - op: add
#      path: /imagePullSecrets
#      value:
#        - name: openshift-pull-secret
#- target:
#    version: v1
#    kind: ServiceAccount
#    name: mongodb-enterprise-database-pods
#    namespace: mongodb
#  patch: |-
#    - op: add
#      path: /imagePullSecrets
#      value:
#        - name: openshift-pull-secret
